<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet type="text/xsl" href="nxdlformat.xsl" ?>
<!--
  # NeXus - Neutron and X-ray Common Data Format
  #
  # Copyright (C) 2014-2021 NeXus International Advisory Committee (NIAC)
  #
  # This library is free software; you can redistribute it and/or
  # modify it under the terms of the GNU Lesser General Public
  # License as published by the Free Software Foundation; either
  # version 3 of the License, or (at your option) any later version.
  #
  # This library is distributed in the hope that it will be useful,
  # but WITHOUT ANY WARRANTY; without even the implied warranty of
  # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
  # Lesser General Public License for more details.
  #
  # You should have received a copy of the GNU Lesser General Public
  # License along with this library; if not, write to the Free Software
  # Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
  #
  # For further information, see http://www.nexusformat.org
-->
<definition name="NXptycho" extends="NXobject" type="group"
			category="application"
			xmlns="http://definition.nexusformat.org/nxdl/3.1"
			xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    		xsi:schemaLocation="http://definition.nexusformat.org/nxdl/3.1 ../nxdl.xsd"
    >
    <symbols>
        <doc>
            These symbols will be used below to coordinate the shapes of the datasets.
        </doc>
    </symbols>

    <doc>
		Application definition for interchange of data from ptychography experiments.
    </doc>

    <group type="NXentry" name="entry_1">
    	<field name="definition" type="NX_CHAR" minOccurs="1" maxOccurs="1">
    		<doc>
                Official NeXus NXDL schema to which this file conforms
            </doc>
    		<enumeration>
    			<item value="NXptycho"/>
    		</enumeration>
		</field>
		<field name="title" minOccurs="0" maxOccurs="1"/>
    	<field name="start_time" type="NX_DATE_TIME" minOccurs="0" maxOccurs="1"/>
    	<field name="end_time" type="NX_DATE_TIME" minOccurs="0" maxOccurs="1"/>
        <field name="experiment_description" type="NX_CHAR" minOccurs="0" maxOccurs="1">
            <doc>
                Brief summary of the experiment, including key objectives. String to define which ptychography
                type was performed, e.g. basic, bragg, fourier, ...
            </doc>
        </field>
		<field name="entry_identifier">
			<doc>
				Unique identifier for the experiment.
			</doc>
		</field>
    	<field name="entry_identifier_uuid" minOccurs="0" maxOccurs="1">
			<doc>
        		(optional) UUID identifier for this entry.
			</doc>
    	</field>
		<field name="entry_number" type="NX_INT">
			<doc>
				Entry or scan number (must be an integer).
				NOTE: Link to collection_identifier.
			</doc>
		</field>

    	<group type="NXinstrument" name="instrument_1" minOccurs="1" maxOccurs="1">
			<group type="NXsource" minOccurs="0" maxOccurs="1" name="source_1">
    			<field name="name" type="NX_CHAR" minOccurs="0" maxOccurs="1"/>
    			<field name="energy" type="NX_FLOAT" minOccurs="0" maxOccurs="1">
    				<doc>
    					This is the energy of the source, not the beamline.
    				</doc>
					<attribute name="units" type="NX_CHAR" optional="false"/>
    			</field>
    			<field name="probe" type="NX_FLOAT" minOccurs="0" maxOccurs="1"/>
    			<field name="type" type="NX_CHAR" minOccurs="0" maxOccurs="1"/>
    		</group>
    		<group type="NXbeam" name="beam_1" minOccurs="1" maxOccurs="1">
    			<field name="incident_energy" type="NX_FLOAT" minOccurs="0" maxOccurs="1">
					<doc>Photon energy of the beam on entering the sample</doc>
    				<attribute name="units" type="NX_CHAR" optional="false"/>
    			</field>
                <field name="incident_wavelength" type="NX_FLOAT" minOccurs="0" maxOccurs="1">
					<doc>Wavelength of the beam on entering the sample</doc>
    				<attribute name="units" type="NX_CHAR" optional="false"/>
    			</field>
    			<field name="extent" type="NX_FLOAT" minOccurs="0" maxOccurs="1">
					<doc>Lateral beam size on entering the sample</doc>
    				<attribute name="units" type="NX_CHAR" optional="false"/>
    			</field>
    			<field name="incident_beam_divergence" type="NX_FLOAT" minOccurs="0" maxOccurs="1">
					<doc>Beam divergence on entering the sample</doc>
    				<attribute name="units" type="NX_CHAR" optional="false"/>
    			</field>
    			<field name="incident_energy_spread" type="NX_FLOAT" minOccurs="0" maxOccurs="1">
					<doc>Energy spread of the beam on entering the sample</doc>
    				<attribute name="units" type="NX_CHAR" optional="false"/>
    			</field>
				<field name="incident_polarization" type="NX_FLOAT" minOccurs="0" maxOccurs="1">
					<doc>Polarization vector of the beam on entering the sample</doc>
    				<attribute name="units" type="NX_CHAR" optional="false"/>
    			</field>
				<field name="flux" type="NX_FLOAT" minOccurs="0" maxOccurs="1">
					<doc>Flux incident on beam plane area</doc>
    				<attribute name="units" type="NX_CHAR" optional="false"/>
    			</field>
    		</group>
    		<group type="NXdetector" name="detector_1" minOccurs="1" maxOccurs="1">
    			<field name="data" type="NX_INT" signal="1"
					   minOccurs="1" maxOccurs="1">
					<doc>
						Data values from the detector.

						This data must always have shape (npts, frame_size_x, frame_size_y) regardless
						of the scan pattern. Use hdf5 virtual dataset to achieve this.
					</doc>
    				<dimensions rank="3 for arbitrary scan">
    					<dim index="1" value="npts"/>
    					<dim index="2" value="frame_size_x"/>
    					<dim index="3" value="frame_size_y"/>
    				</dimensions>
    			</field>
    			<link name="data" target="/NXentry/NXinstrument/NXdetector/data">
    			</link>
    			<field name="x_pixel_size" type="NX_FLOAT" units="NX_LENGTH" minOccurs="1" maxOccurs="1">
					<doc>Horizontal pixel size of the detector</doc>
    				<attribute name="units" type="NX_CHAR" optional="false"/>
    			</field>
                <field name="y_pixel_size" type="NX_FLOAT" units="NX_LENGTH" minOccurs="1" maxOccurs="1">
					<doc>Vertical pixel size of the detector</doc>
                	<attribute name="units" type="NX_CHAR" optional="false"/>
                </field>
    			<field name="distance" type="NX_FLOAT" units="NX_LENGTH" minOccurs="1" maxOccurs="1">
    			    <doc>The distance between the detector and the sample</doc>
    				<attribute name="units" type="NX_CHAR" optional="false"/>
                </field>
                <field name="beam_center_x" type="NX_FLOAT" units="NX_LENGTH" minOccurs="0" maxOccurs="1">
					<doc>Center of the beam on the detector in horizontal direction</doc>
                	<attribute name="units" type="NX_CHAR" optional="false"/>
                </field>
                <field name="beam_center_y" type="NX_FLOAT" units="NX_LENGTH" minOccurs="0" maxOccurs="1">
					<doc>Center of the beam on the detector in vertical direction</doc>
                	<attribute name="units" type="NX_CHAR" optional="false"/>
                </field>
				<group type="NXtransformations" name="transformations">
					<doc>
						Defines the location and orientation of the detector.
					</doc>
					<field name="axisname" type="NX_NUMBER" units="NX_TRANSFORMATION">
						<doc>
							The name of this field is not forced. The user is free to use any name that does not cause
							confusion. When using more than one AXISNAME field, make sure that each field name is
							unique in the same group, as required by HDF5.
							The values given should be the start points of exposures for the corresponding frames.
							The end points could be given in ``AXISNAME_end``.

							See a general example here:
							https://manual.nexusformat.org/design.html#coordinate-transformation-field-and-attributes

							Example for simple ptychography experiment in translation geometry:
								AXISNAME = "x_translation"
									@transformation_type = "translation"
									@vector:NX_NUMBER = 1,0,0
									@offset:NX_NUMBER = 0,0,0
									@offset_units = "m"
									@depends_on = "y_translation"
								AXISNAME = "y_translation"
									@transformation_type = "translation"
									@vector = 0,1,0
									@offset = 0,0,0
									@offset_units = "m"
									@depends_on = "z_translation"
								AXISNAME = "z_translation"
									@transformation_type = "translation"
									@vector = 0,0,1
									@offset = 0,0,0
									@offset_units = "m"
									@depends_on = .

						</doc>
						<attribute name="transformation_type" type="NX_CHAR" optional="false"/>
						<attribute name="vector" type="NX_NUMBER" optional="false"/>
						<attribute name="offset" type="NX_NUMBER" optional="false"/>
						<attribute name="offset_units" type="NX_CHAR" optional="false"/>
						<attribute name="depends_on" type="NX_CHAR" optional="false"/>
					</field>
				</group>

			<group type="NXmonitor" minOccurs="0" maxOccurs="1">
				<field name="data" type="NX_FLOAT">
				    <dimensions rank="1 for arbitrary scan, 2 for raster">
    					<dim index="1" value="npts_x"/>
    					<dim index="2" value="npts_y"/>
    				</dimensions>
				</field>
			</group>
    		</group>
		</group>


		<group type="NXdata" minOccurs="1" maxOccurs="1">
			<attribute name="signal" type="NX_CHAR" optional="false">
				<doc>
					This is the plottable data.
				</doc>
			</attribute>
			<link name="data" target="/NXentry/NXinstrument/NXdetector/data"/>
		</group>


		<group type="NXsample" name="sample_1" minOccurs="1" maxOccurs="1">
			<field name="name" type="NX_CHAR" minOccurs="0" maxOccurs="1"/>
			<group type="NXtransformations" name="transformation">
				<doc>
					Defines the location and orientation of the sample.
					 <!-- TODO: set links to positioners -->
				</doc>
				<field name="axisname" type="NX_NUMBER" units="NX_TRANSFORMATION">
					<attribute name="transformation_type" type="NX_CHAR" optional="false"/>
					<attribute name="vector" type="NX_NUMBER" optional="false"/>
					<attribute name="units" type="NX_CHAR" optional="false"/>
					<attribute name="offset_units" type="NX_CHAR" optional="false"/>
					<attribute name="depends_on" type="NX_CHAR" optional="false"/>
				</field>
			</group>
			<group type="NXpositioner" name="positions">
				<doc>
					Defines the location and orientation of the sample.
				</doc>
				<field name="name" type="NX_NUMBER" units="NX_TRANSFORMATION"></field>
				<field name="value" type="NX_NUMBER" units="NX_ANY"></field>
				<field name="raw_value" type="NX_NUMBER" units="NX_ANY"></field>
				<field name="target_value" type="NX_NUMBER" units="NX_ANY"></field>
			</group>
		</group>

	</group>
</definition>
